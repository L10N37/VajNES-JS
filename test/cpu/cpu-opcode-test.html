<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>6502 Opcode Batch Test Runner</title>

  <!-- Core CPU and memory implementations -->
  <script src="/assets/js/6502.js"></script>
  <script src="/assets/js/memory.js"></script>
  <!-- Your comprehensive test definitions -->
  <script src="./cpu-opcode-test.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    section { margin-bottom: 40px; }
    h2 { margin-top: 30px; border-bottom: 2px solid #333; padding-bottom: 5px; }
    table { border-collapse: collapse; width: 100%; max-width: 900px; }
    th, td { border: 1px solid #ccc; padding: 8px; vertical-align: top; text-align: left; }
    th { background-color: #f4f4f4; }
    .pass { color: green; font-weight: bold; }
    .fail { color: red; font-weight: bold; }
    pre { margin: 0; font-family: monospace; }
  </style>
</head>
<body>
  <h1>6502 Opcode Batch Test Runner</h1>
  <div id="resultsContainer"></div>

  <script>
    // Snapshot helper
    function cloneState() {
      return {
        A: CPUregisters.A,
        X: CPUregisters.X,
        Y: CPUregisters.Y,
        PC: CPUregisters.PC,
        SP: CPUregisters.SP,
        P: { ...CPUregisters.P }
      };
    }

    window.onload = function() {
      // Gather and group tests
      const tests = Object.keys(window)
        .filter(name => typeof window[name] === 'function' && name.startsWith('test_'))
        .map(name => {
          const category = name.split('_')[1];
          return { name, fn: window[name], category };
        });
      const groups = tests.reduce((acc, t) => {
        (acc[t.category] = acc[t.category] || []).push(t);
        return acc;
      }, {});

      const container = document.getElementById('resultsContainer');
      Object.keys(groups).forEach(cat => {
        const section = document.createElement('section');
        section.innerHTML = `<h2>${cat} Tests</h2>`;
        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr>
              <th>Test</th>
              <th>Result</th>
              <th>Pre-exec snapshot (post-setup)</th>
              <th>Post-exec snapshot</th>
              <th>Message</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');

        groups[cat].forEach(test => {
          resetCPU();
          const before = cloneState();
          let result = 'PASS', message = '';
          try { test.fn(); }
          catch (e) { result = 'FAIL'; message = e.message; }
          const after = cloneState();

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${test.name}</td>
            <td class="${result.toLowerCase()}">${result}</td>
            <td><pre>${JSON.stringify(before, null, 2)}</pre></td>
            <td><pre>${JSON.stringify(after, null, 2)}</pre></td>
            <td>${message}</td>
          `;
          tbody.appendChild(row);
        });

        section.appendChild(table);
        container.appendChild(section);
      });
    };
  </script>
</body>
</html>
