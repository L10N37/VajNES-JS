<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="CSS-Reset" href="assets/css/reset.css" />
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="assets/css/screen.css" />
  <link rel="stylesheet" href="assets/css/customise.css" />
  <link rel="stylesheet" href="disasm/disasm.css">

    <!-- Fixes new firefox feature 'auto hiding scrollbars/ overlay scrollbars' -->
    <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow-y: scroll;       /* Always show scrollbar */
      scrollbar-width: auto;    /* Normal width */
      scrollbar-gutter: stable; /* No layout shift */
    }
    body {
      font-family: sans-serif;
    }
    .content {
      height: 200vh; /* Just to make page scrollable */
      background: linear-gradient(#ddd, #aaa);
    }
  </style>

</head>
<body>
  <header>
    <div class="windows-bar">
      <div class="file-dropdown">
        <button class="dropbtn">File</button>
        <div class="dropdown-content" id="file-upload-button">
          <input class='fileMenuItems' type="file" onchange="readFile(this)">
          <button class ='fileMenuItems' id="header-button">ROM Header Information</button>
        </div>
      </div>
      <div>
        <button class="dropbtn" id="clickedDisplay">Display</button>
        <button class="dropbtn" id="clickedScreen"> Screen</button>
        <button class="dropbtn" id="clickedTileView">Tile View</button>
        <button class="dropbtn" id="dumpState">Dump</button>
        <button class="dropbtn" id="open-disasm">DisAsm</button>
      </div>

    </div>
  </header>

  <!-- Tile Viewer Modal -->
  <div id="tileModal" class="TileViewModal" aria-hidden="true">
    <div class="tileView-modal-box" role="dialog" aria-labelledby="tileViewerTitle">
      <div class="modal-header">
        <h2 id="tileViewerTitle">NES Tile Viewer</h2>
        <button id="closeTileModal" class="close-button" aria-label="Close">&times;</button>
      </div>

      <div class="tileView-content">
        <div class="canvas-wrapper">
          <div class="canvas-container">
            <h3>Name Table 0</h3>
            <canvas id="bgCanvas" width="256" height="256"></canvas>
          </div>
          <div class="canvas-container">
            <h3>Name Table 1</h3>
            <canvas id="fgCanvas" width="256" height="256"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal window -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="contra-gif-container">
        <img src="assets/images/bg/contraBoss.gif" alt="contra boss gif" style="max-width: 100%; border-radius: 25px;">

      </div>
      <h2>Background</h2>
      <label><input type="radio" name="background" value='#36383b'> Default</label><br>
      <label ><input type="radio" name="background" value="white"> White</label><br>
      <label><input type="radio" name="background" value="black"> Black</label><br>
      <label><input type="radio" name="background" value="gray"> Gray</label><br>
      <label><input type="radio" name="background" value="red"> Red</label><br>
      <label><input type="radio" name="background" value="green"> Green</label><br>
      <label><input type="radio" name="background" value="blue"> Blue</label><br>
      <label><input type="radio" name="image" value="assets/images/bg/contra1.jpg"> Contra</label><br>
      <label><input type="radio" name="image" value="assets/images/bg/contraGif.gif"> Contra GIF</label><br>
      <label><input type="radio" name="image" value="assets/images/bg/superContra.jpg"> Super Contra</label><br>
      <label><input type="radio" name="image" value="assets/images/bg/doubleDragon2.png"> Double Dragon 2</label><br>      
      <br>
      <button id="modal-ok-btn">OK</button>
    </div>
  </div>
  
  <main>

    
<div class="wram-header">| WRAM + Mirrors<loc>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Offset: </loc> <span id="locContainer"></span></div>
<article class="debug"></article>

<div class="vram-header">| PPU Memory Space<loc>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Offset: </loc> <span id="locContainer2"></span></div>
<article class="debug2"></article>

<div class="prgrom-header">| PRG-ROM<loc>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Offset: </loc> <span id="locContainer3"></span></div>
<article class="debug3"></article>


  <!-- Wrap CPU + PPU side by side -->
  <div class="registers-row">
    <article class="CPU-registers">
      <registersText>CPU Register Bits</registersText>
      <!-- CPU table is injected here -->
    </article>
    <article class="PPU-registers">
      <registersText>PPU Register Bits</registersText>
      <!-- PPU table is injected here -->
    </article>
  </div>

  <!-- Flags centered below -->
  <article class="flag-register">
    <registersText>Status Register Flags (P)</registersText>
    <!-- your Flags table is injected here -->
  </article>

  <section class="instruction-step"></section>
</main>

  <!-- the 256 * 240 NTSC screen modal, size set in js file (PAL is 256 * 288) -->
    <div id="system-screen-modal" class="screenModal">
      <canvas id="screen-canvas"></canvas>
      <div class="optionsBar">
        <ul>
          <li>Scale</li>
          <li>Scanlines</li>
          <li>Palette</li>
          <li>FPS</li>
          <li>Exit</li>
        </ul>
      </div>
    </div>

<!-- Grille underlay for grille emulation -->
<div id="grille-screen-modal" class="grilleScreenModal">
  <canvas id="grille-canvas"></canvas>
</div>

<!-- Another underlay for scanline simulation -->
<div id="scanline-simulation-modal" class="scanlineSimulationModal">
  <canvas id="scanline-canvas"></canvas>
</div>

<!-- Solid black underlay to block main page -->
<div id="black-screen-modal" class="blackScreenModal"></div>

<!-- Scanline options -->
<div class="scanlinesModal">
  <!-- Predefined scanline images -->
  <div>
    <input type="radio" id="scanlines1" name="scanlines" value="scanlines1">
    <label for="scanlines1">Scanlines 1 (BG image)</label><br>

    <input type="radio" id="scanlines2" name="scanlines" value="scanlines2">
    <label for="scanlines2">Scanlines 2 (BG image)</label><br>

    <input type="radio" id="scanlines3" name="scanlines" value="scanlines3">
    <label for="scanlines3">Scanlines 3 (BG image)</label><br>
  </div>

  <!-- Scanlines intensity slider -->
  <div>
    <br>
    <label for="scanlines-intensity-slider">Scanlines Intensity (overrides above options):</label>
    <input type="range" id="scanlines-intensity-slider" min="0" max="100" value="50">
  </div>

  <!-- Scanlines Tune (code-drawn scanlines) -->
  <div>
    <br>
    <strong>Scanlines Tune</strong><br>

    <label for="scanline-lineheight">Line height (px):</label>
    <input type="number" id="scanline-lineheight" min="1" max="8" value="2" style="width:64px;"><br>

    <label for="scanline-gap">Gap (px):</label>
    <input type="number" id="scanline-gap" min="0" max="12" value="2" style="width:64px;"><br>

    <label for="scanline-offset">Offset:</label>
    <input type="checkbox" id="scanline-offset">
  </div>

  <!-- Live test sources (mutually exclusive) -->
  <div>
    <br>
    <input type="checkbox" id="test-rgba-checkbox"  name="test-source" value="rgba">
    <label for="test-rgba-checkbox">Run testRGBAAnim()</label><br>

    <input type="checkbox" id="test-index-checkbox" name="test-source" value="index">
    <label for="test-index-checkbox">Run testIndexAnim()</label><br>

    <input type="checkbox" id="test-image-checkbox" name="test-source" value="image">
    <label for="test-image-checkbox">Show Test Image</label>
  </div>

  <!-- Grille and transparency controls -->
  <br>
  <div>
    <label for="intensity-slider">Grille Intensity (MUST adjust for retrofx tuning):</label>
    <input type="range" id="intensity-slider" min="0" max="100" value="50">
  </div>

  <div>
    <label for="transparency-slider">Screen Transparency (MUST adjust for retrofx tuning):</label>
    <input type="range" id="transparency-slider" min="0" max="100" value="50">
  </div>

  <!-- Grille type selection -->
  <div>
    <input type="radio" id="aperture-grille" name="grille-type" value="aperture-grille">
    <label for="aperture-grille">Aperture Grille</label><br>

    <input type="radio" id="shadow-mask" name="grille-type" value="shadow-mask">
    <label for="shadow-mask">Shadow Mask</label><br>

    <input type="radio" id="none" name="grille-type" value="none">
    <label for="none">None</label><br>
  </div>

  <!-- Composite blur control -->
  <br>
  <label for="composite-blur-slider">Composite Blur:</label>
  <input type="range" id="composite-blur-slider" min="0" max="5" value="0" step="0.1">

  <!-- OK button -->
  <div>
    <button id="ok-button">OK</button>
  </div>
</div>

<!-- Scale options modal (mouse-accessible, F2 shortcut) -->
<div id="scale-modal" class="modal">
  <div class="modal-content">
    <span class="closeModal">&times;</span>
    <form>
      <h2>Scale Factor</h2>

      <label><input type="radio" name="scaleFactor" value="2" checked> 2x</label><br>
      <label><input type="radio" name="scaleFactor" value="3"> 3x</label><br>
      <label><input type="radio" name="scaleFactor" value="4"> 4x</label><br>
      <label><input type="radio" name="scaleFactor" value="5"> 5x</label><br>
      <label><input type="radio" name="scaleFactor" value="5.4"> 5.4x</label>
    </form>
  </div>
</div>

<script src="assets/js/shared-assets.js"></script>

<script src="assets/js/helpers.js"></script>
<script src="assets/js/interrupts.js"></script>
<script src="assets/js/6502.js"></script>
<script src="assets/js/memory.js"></script>
<script src="assets/js/memoryMaps.js"></script>

<script src="assets/js/offsetsHandler.js"></script>

<script src="assets/js/screen/palettes.js"></script>

<script src="assets/js/APU.js"></script>
<script src="assets/js/mapper.js"></script>
<script src="assets/js/controller.js"></script>
<script src="assets/js/readFile.js"></script>

<script src="assets/js/screen/analogueFuzz.js"></script>
<script src="assets/js/screen/screen.js"></script>

<script src="assets/js/screen/grille.js"></script>
<script src="assets/js/screen/scanlines.js"></script>
<script src="assets/js/screen/scale.js"></script>

<script src="assets/js/screen/tileViewer.js"></script>
<script src="assets/js/customise/display.js"></script>


<script src="assets/js/debugTables/tables.js"></script>
<script src="assets/js/debugTables/cpuRegisterUi.js"></script>
<script src="assets/js/debugTables/ppuRegister.Ui.js"></script>
<script src="assets/js/debugTables/cpuStatusRegisterUi.js"></script>

<script src="test/testSuite.js"></script>
<script src="test/benchmarks/benchMarkTests.js"></script>
<script src="test/standaloneCallInConsoleTests.js"></script>
<script src="assets/js/logDump.js"></script>


<script src="disasm/disasm.js"></script>
<script src="assets/js/debug.js"></script>


<!--tests-->
<script src="test/ppuSimulation/ppu-sim.js"></script>
<script src="test/ppuSimulation/ppu-sim-direct.js"></script>
<script src="test/offsets/offset-test.js"></script>
<script src="test/dump-bg.js"></script>
<script src="test/consoleTests.js"></script>

<!-- purely for disassembler, absolutely nailed the desired outcome/ aesthetics for the window, but can't drag out of DOM -->
<script src="/disasm/winbox.bundle.min.js"></script>
<script>
function launchDisasmWindow() {
  const win = new WinBox({
    title: "NES Disassembler",
    width: 720,
    height: 720,
    x: "center",
    y: "center",
    class: ["no-max", "no-min"],
    background: "#111",
    border: 0,
    onload: () => {
      console.debug("[winbox] Disasm window loaded.");
    }
  });

  // Build disasm content dynamically
  const wrap = document.createElement("div");
  wrap.className = "wrap";
  wrap.innerHTML = `
    <header class="bar">
      <div class="title">DISASSEMBLER</div>
      <span id="cycles-wrap" style="margin-left:10px;">
        CPU Cycles: <span id="cycles-value">--</span>
        <button id="cycles-update" class="btn">Update</button>
      </span>
      <button id="csv-export" class="btn">Export CSV</button>
      <button id="theme-toggle" class="btn">Theme: Amber</button>
    </header>

    <main id="view" class="viewport" tabindex="0" role="log" aria-live="polite">
      <table class="disasm">
        <thead>
          <tr class="hdr">
            <th class="col-pc">PC</th><th class="col-opc">OPC</th><th class="col-op">OP</th>
            <th class="col-mn">MNEMONIC</th><th class="col-notes">NOTES</th>
            <th class="col-reg">A</th><th class="col-reg">X</th><th class="col-reg">Y</th>
            <th class="col-bit">C</th><th class="col-bit">Z</th><th class="col-bit">I</th>
            <th class="col-bit">D</th><th class="col-bit">V</th><th class="col-bit">N</th>
            <th class="col-reg">S</th>
          </tr>
          <tr class="sep"><td colspan="15"></td></tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
      <div class="scan" aria-hidden="true"></div>
    </main>

    <footer class="keybar">
      <span>R = Run</span><span>P = Pause</span><span>S = Step</span>
      <span>U = Update Cycles</span><span>T = Theme</span>
    </footer>
  `;

  win.mount(wrap);

  // Theme toggle
  const html = wrap.ownerDocument.documentElement;
  const themeBtn = wrap.querySelector("#theme-toggle");
  function setTheme(name) {
    html.setAttribute("data-theme", name);
    themeBtn.textContent = "Theme: " + (name === "amber" ? "Amber" : "Green");
  }
  themeBtn.onclick = () => {
    const newTheme = html.getAttribute("data-theme") === "amber" ? "green" : "amber";
    setTheme(newTheme);
  };

  // CPU Cycle update
  wrap.querySelector("#cycles-update").onclick = () => {
    const val = window.DebugCtl?.cpuCycles ?? "--";
    wrap.querySelector("#cycles-value").textContent = val;
  };

  // CSV Export
  wrap.querySelector("#csv-export").onclick = () => {
    const rows = Array.from(wrap.querySelectorAll("tbody tr"));
    const csv = rows.map(tr =>
      Array.from(tr.querySelectorAll("td")).map(td => td.textContent.trim()).join(",")
    ).join("\n");

    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "disasm_log.csv";
    a.click();
  };

  // Keyboard support
  wrap.addEventListener("keydown", e => {
    if (e.repeat) return;
    const k = e.key.toLowerCase();
    if (["input", "textarea"].includes(e.target.tagName.toLowerCase())) return;

    if (k === 'r') window.DebugCtl?.run?.();
    if (k === 'p') window.DebugCtl?.pause?.();
    if (k === 's') window.DebugCtl?.step?.();
    if (k === 'u') wrap.querySelector("#cycles-update").click();
    if (k === 't') themeBtn.click();
  });

  // Add row function
  const rowsEl = wrap.querySelector("#rows");
  const viewEl = wrap.querySelector("#view");
  function appendDisasmRow(html) {
    if (!rowsEl || typeof html !== "string") return;
    rowsEl.insertAdjacentHTML("beforeend", html);
    while (rowsEl.children.length > 256) {
      rowsEl.removeChild(rowsEl.firstElementChild);
    }
    if (viewEl) viewEl.scrollTop = viewEl.scrollHeight;
  }

  // Global handle
  window.DISASM = { appendRow: appendDisasmRow };
}
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const disasmBtn = document.getElementById("open-disasm");
  if (disasmBtn) {
    disasmBtn.onclick = () => {
      disasmRunning = true;
      launchDisasmWindow();
    };
  }
});
</script>

</body>
<footer>
</footer>
</html>
  

